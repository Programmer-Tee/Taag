function configRouterProvider(e){e.when("/home",{title:"Home",templateUrl:"/html/views/home.html",controller:"HomeCtrl",resolve:HomeCtrl.ready}).when("/",{title:"Email services",templateUrl:"/html/views/services.html",controller:"ServicesCtrl",resolve:ServicesCtrl.ready}).when("/templates",{title:"Email templates",templateUrl:"/html/views/email_templates.html",controller:"EmailTemplatesCtrl",resolve:EmailTemplatesCtrl.ready}).when("/templates/:system_id",{title:"Email template editor",templateUrl:"/html/views/email_template.html",controller:"EmailTemplateCtrl",resolve:EmailTemplateCtrl.ready}).when("/integration",{title:"Integration",templateUrl:"/html/views/integration.html",controller:"AppController",resolve:AppController.ready}).when("/account",{title:"Account",templateUrl:"/html/views/account/account.html",controller:"UserCtrl",resolve:UserCtrl.ready}).when("/account/login",{title:"Login",templateUrl:"/html/views/account/login.html",controller:"UserCtrl",resolve:UserCtrl.ready}).when("/account/create",{title:"Create account",templateUrl:"/html/views/account/create_account.html",controller:"UserCtrl",resolve:UserCtrl.ready}).when("/account/forgot_password",{title:"Forgot password",templateUrl:"/html/views/account/forgot_password.html",controller:"UserCtrl",resolve:UserCtrl.ready}).when("/account/reset_password",{title:"Reset password",templateUrl:"/html/views/account/reset_password.html",controller:"UserCtrl",resolve:UserCtrl.ready}).when("/account/plans",{title:"Plans",templateUrl:"/html/views/account/plans.html",controller:"UserCtrl",resolve:UserCtrl.ready}).when("/history",{title:"Email History",templateUrl:"/html/views/email-history.html",controller:"EmailHistoryCtrl",resolve:EmailHistoryCtrl.ready}).when("/events",{title:"Events",templateUrl:"/html/views/logs.html",controller:"LogsCtrl",resolve:LogsCtrl.ready}).when("/statistics",{title:"Statistics",templateUrl:"/html/views/statistics.html",controller:"StatisticsCtrl",resolve:StatisticsCtrl.ready}).when("/contacts",{title:"Contacts",templateUrl:"/html/views/contacts.html",controller:"ContactsCtrl",resolve:ContactsCtrl.ready}).otherwise({title:"Page not found",templateUrl:"/html/views/404.html"})}function AppController(r,e,t,a,n){r.CONFIG={server:"https://api.emailjs.com"},r.plans=[{id:"free",name:"Free",label:"For Testing",pricing:{monthly:{amount:0},yearly:{amount:0}},features:["200 monthly requests","2 email templates","Requests up to 50Kb","Limited contacts history"]},{id:"basic",name:"Personal",label:"For Personal Use",pricing:{monthly:{amount:5,checkout_page:"https://sites.fastspring.com/emailjs/instant/eTQLnceE"},yearly:{amount:48,checkout_page:"https://sites.fastspring.com/emailjs/instant/4emqhCij"}},features:["1,000 monthly requests","5 email templates","Whitelist","Unlimited contacts","Attachments up to 500kb","Completely white label"]},{id:"professional",name:"Professional",label:"Entrepreneurs & Freelancers",highlight:!0,pricing:{monthly:{amount:15,checkout_page:"https://sites.fastspring.com/emailjs/instant/lR0hR4ib"},yearly:{amount:144,checkout_page:"https://sites.fastspring.com/emailjs/instant/lRYcVxgn"}},features:["5,000 monthly requests","Unlimited email templates","Whitelist","Unlimited contacts","Attachments up to 2mb","Completely white label","Priority email support"]},{id:"business",name:"Business",label:"Best for Small Business",pricing:{monthly:{amount:50,checkout_page:"https://sites.fastspring.com/emailjs/instant/zoAON8ns"},yearly:{amount:480,checkout_page:"https://sites.fastspring.com/emailjs/instant/By2Emer1"}},features:["25,000 monthly requests","Unlimited email templates","Whitelist","Unlimited contacts","Attachments up to 20mb","Completely white label","Priority email support","Phone support"]},{id:"enterprise",name:"Enterprise",label:"For Seriously Customers",pricing:{monthly:{amount:200,checkout_page:"https://sites.fastspring.com/emailjs/instant/Ox7hAZdy"},yearly:{amount:1920,checkout_page:"https://sites.fastspring.com/emailjs/instant/7eCBPbuY"}},features:["200,000 monthly emails","Unlimited email templates","Whitelist","Unlimited contacts","Attachments up to 20mb","Completely white label","Priority email support","Phone support"]}],r.SERVICE_PROVIDERS=[{type:"personal",provider:"Gmail",display:"Gmail",isDeprecated:!0,icon:"gmail.png"},{type:"personal",provider:"Gmail_API",display:"Gmail",icon:"gmail.png"},{type:"personal",provider:"AOL",display:"AOL",icon:"aol.png",note:'Required to change the <a href="https://login.aol.com/account/security" target="_blank">Account Security</a>: You need to turn on the "Allow apps that use less secure sign in" option',fields:[{field_name:"User Email:",model:"email"},{field_name:"User Password:",model:"password",password:!0}]},{type:"personal",provider:"FastMail",display:"FastMail",icon:"fastmail.png",note:'Required the <a href="https://www.fastmail.com/help/clients/apppassword.html" target="_blank">App Passwords</a>',fields:[{field_name:"User Email:",model:"email"},{field_name:"App Password:",model:"password",password:!0}]},{type:"personal",provider:"iCloud",display:"iCloud",icon:"icloud.png",note:'Required the <a href="https://support.apple.com/en-us/HT204397" target="_blank">app-specific passwords</a>',fields:[{field_name:"User Email:",model:"email"},{field_name:"App Password:",model:"password",password:!0}]},{type:"transactional",provider:"Mailgun",display:"Mailgun",icon:"mailgun.png",note:null,fields:[{field_name:"API Key:",model:"api_key"},{field_name:"Domain:",model:"domain"},{field_name:"Region:",model:"region",regions:[{value:"us",name:"United States"},{value:"eu",name:"Europe"}]}]},{type:"transactional",provider:"Mailjet",display:"Mailjet",icon:"mailjet.png",note:'The sending address must be active in <a href="https://www.mailjet.com/support/how-to-add-a-sender-address,96.htm" target="_blank">Sender addresses</a>',fields:[{field_name:"API Key:",model:"api_key"},{field_name:"Secret Key:",model:"secret_key"}]},{type:"transactional",provider:"Mandrill",display:"Mandrill",icon:"mandrill.png",note:null,fields:[{field_name:"API Key:",model:"api_key"}]},{type:"personal",provider:"Mail.ru",display:"Mail.ru",icon:"mailru.png",note:null,fields:[{field_name:"User Email:",model:"email"},{field_name:"User Password:",model:"password",password:!0}]},{type:"transactional",provider:"SendinBlue",display:"SendinBlue",icon:"sendinblue.png",note:null,unavailable:!0,fields:[{field_name:"User Email:",model:"email"},{field_name:"User Password:",model:"password",password:!0}]},{type:"personal",provider:"Hotmail",display:"Outlook",icon:"outlook.png",note:null,fields:[{field_name:"User Email:",model:"email"},{field_name:"User Password:",model:"password",password:!0}]},{type:"transactional",provider:"SendGrid",display:"SendGrid",icon:"sendgrid.png",note:'The API key with Mail Send access can be obtained from Sendgrid dashboard. <a href="https://sendgrid.com/docs/User_Guide/Settings/api_keys.html#-Create-an-API-Key" target="_blank">Learn more</a>',fields:[{field_name:"API KEY:",model:"api_key"}]},{type:"transactional",provider:"SES",display:"Amazon SES",icon:"ses.png",note:'Required User with ses:SendRawEmail permission. <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/control-user-access.html" target="_blank">Learn more</a>',fields:[{field_name:"Access Key ID:",model:"access_key"},{field_name:"Secret Key:",model:"secret_key"},{field_name:"Region:",model:"region",regions:[{value:"us-west-2",name:"US West (Oregon)"},{value:"eu-west-1",name:"EU (Ireland)"},{value:"us-east-1",name:"US East (N. Virginia)"}]}]},{type:"transactional",provider:"Postmark",display:"Postmark",icon:"postmark.png",note:null,fields:[{field_name:"Server API token:",model:"api_key"}]},{type:"personal",provider:"Yahoo",display:"Yahoo",icon:"yahoo.jpg",note:'Required to change the <a href="https://login.yahoo.com/account/security" target="_blank">Account Security</a>: You need to turn on the "Allow apps that use less secure sign in" option',fields:[{field_name:"User Email:",model:"email"},{field_name:"User Password:",model:"password",password:!0}]},{type:"personal",provider:"Yandex",display:"Yandex",icon:"yandex.png",note:null,fields:[{field_name:"User Email:",model:"email"},{field_name:"User Password:",model:"password",password:!0}]},{type:"personal",provider:"Zoho",display:"Zoho",icon:"zohomail.png",note:'You may require an <a href="https://www.zoho.com/mail/help/adminconsole/two-factor-authentication.html#alink5" target="_blank">Application-specific Password</a> to set up the account in other devices if you\'ve enabled Two-Factor Authentication.',fields:[{field_name:"User Email:",model:"email"},{field_name:"User Password:",model:"password",password:!0}]},{type:"personal",provider:"SMTP",display:"SMTP server",icon:"smtp.jpg"}],r.SERVICES_INFO={};for(var s=0;s<r.SERVICE_PROVIDERS.length;s++)r.SERVICES_INFO[r.SERVICE_PROVIDERS[s].provider]=r.SERVICE_PROVIDERS[s];r.TEMPLATE_DESIGNS=[{name:"Blank",template:"blank.html"},{name:"Mailgun Action",template:"mailgun_action.html"},{name:"Mailgun Alert",template:"mailgun_alert.html"},{name:"Mailgun Billing",template:"mailgun_billing.html"},{name:"Postmark Welcome",template:"postmark_welcome.html"},{name:"Cakemail",template:"cakemail.html"}],r.UPGRADE_LINK="/account/plans",r.DEFAULT_SERVICE_ID="default_service",r.tinymceOptions={menubar:!1,plugins:["lists link image code fullscreen media table textcolor colorpicker preview "],toolbar1:"bold italic underline strikethrough | fontselect fontsizeselect | forecolor backcolor | alignleft aligncenter alignright alignjustify",toolbar2:"bullist numlist blockquote outdent indent | link unlink | image | undo redo | code | preview fullscreen"},r.emailjs=emailjs,r.free_user="free"==Inffuse.user.plan(),r.default_template={to_email:"",attachments:[],static_attachments:[],subject:"[EmailJS example] New message from {{from_name}}",reply_to:"{{reply_to}}",content:'<div style="border: 1px solid #e5e5e5; padding: 15px 20px; max-width: 600px; margin: auto;">\n<p>Hello {{to_name}},<br /><br />You got a new message from {{from_name}}:</p>\n<p style="padding: 12px; border-left: 6px solid #eee; font-style: italic;">{{{message_html}}}</p>\n<p>&nbsp;<br />Best wishes,<br />EmailJS team</p>\n</div>',use_default_from_email:!0,captcha:!1,name:"Email Template Example",auto_reply:!1,auto_reply_params:{to_email:"",from_email:"",from_name:"",subject:"",content:""},add_contact:!1,add_contact_params:{email:"",name:"",address:"",phone:""}},r.integration_code='<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@2.3.2/dist/email.min.js"><\/script>\n<script type="text/javascript">\n\t(function(){\n\t\temailjs.init("'+Inffuse.user.id()+'");\n\t})();\n<\/script>\n',r.init=function(){switch(hljs.configure({tabReplace:"   "}),r.emailjs.init(Inffuse.user.id(),r.CONFIG.server),r.data={},r.dataStore=Inffuse.user.getDataStore(),r.user_plan=Inffuse.user.plan(),r.max_templates=1e3,r.user_plan){case"free":r.max_templates=2;break;case"basic":r.max_templates=5}r.data.settings=r.dataStore.get("settings");var e=!1;if(void 0===r.data.settings?(r.data.settings={subsribe_to_weekly_report:!0},r.data.settings={subsribe_to_monthly_report:!0},e=!0):(void 0===r.data.settings.subsribe_to_weekly_report&&(e=r.data.settings.subsribe_to_weekly_report=!0),void 0===r.data.settings.subsribe_to_monthly_report&&(e=r.data.settings.subsribe_to_monthly_report=!0)),e){var t=r.clean(r.data.settings);r.dataStore.set("settings",t),r.resetUser()}if(r.$watch("data.settings",function(e,t){if(e!==t){var a=r.clean(r.data.settings);r.dataStore.set("settings",a),r.resetUser()}},!0),r.data.services=r.dataStore.get("services",[]),r.$watch("data.services",function(e,t){if(e!==t){var a=r.clean(r.data.services);r.dataStore.set("services",a),r.resetUser()}},!0),r.data.templates=r.dataStore.get("templates"),void 0===r.data.templates){r.default_template.system_id=r.generateID(10),r.default_template.id="template_"+r.generateID(8),r.default_template.to_email=Inffuse.user.email(),r.default_template.from_name=Inffuse.user.name(),r.default_template.use_default_from_email=!0,r.data.templates=[r.default_template];var a=r.clean(r.data.templates);r.dataStore.set("templates",a),r.resetUser()}r.quota=Inffuse.quotas.get(Inffuse.user.plan()),window.HW_config={selector:"#welcome",account:"RyEW27"},setTimeout(function(){$("head").append('<script async src="//cdn.headwayapp.co/widget.js"><\/script>')}),$("#header-menu").on("mousedown","#HW_badge_cont",function(){r.track("Notifications opened")}),window.onfocus=function(){r.$broadcast("focus")}},r.refreshQuota=function(){Inffuse.quotas.consume(Inffuse.user.plan(),0).done(function(e){r.quota=e.quota,r.$apply()}).fail(function(){r.quota=null,r.$apply()})},r.showError=function(e,t){r.openDialog("error",{title:e,message:t})},r.openDialog=function(e,t){r._dialog=e,r._formdata=r.clean(t),r.track("Dialog opened",e)},r.closeDialog=function(e){r._formdata&&r._formdata.onClose&&r._formdata.onClose(),r._dialog=null,delete r._formdata},r.getDialogTemplate=function(){return"/html/dialogs/"+r._dialog+".html"},r.isSelectedView=function(e){return"/"==e?n.url()==e:0==n.url().indexOf(e)},r.clone=function(e){return JSON.parse(JSON.stringify(e))},r.generateUniqueId=function(){return""+1*new Date},r.generateJavascriptId=function(e){return e.toLowerCase().replace(/\W+/g,"_")},r.generateID=function(e){for(var t="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",a="",r=0;r<e;r++)a+=t[Math.floor(Math.random()*t.length)];return a},r.isempty=function(e){return!e||0==Object.keys(e).length},r.safeParse=function(t){var a;try{a=JSON.parse(t)}catch(e){a={content:t}}return a},r.updateWhitelist=function(e){r.error=null;var t=e.whitelist.replace(/\s+/g,"");return r.data.settings.whitelist=t?t.split(","):"",r.dataStore.set("settings",r.clean(r.data.settings)).fail(function(e){void 0!==e.responseJSON.error?r.error=e.responseJSON.error:r.error="Unhandled error while updating settings parameters!",r.track("Whitelist updated"),r.$apply()})},r.clean=function(e){switch(Object.prototype.toString.call(e)){case"[object Object]":var t={};for(var a in e){var r=a.substr(0,1);"_"!=r&&"$"!=r&&(t[a]=this.clean(e[a]))}return t;case"[object Array]":t=[];for(var a in e)t[a]=this.clean(e[a]);return t}return e},r.updateUser=function(){if(Inffuse.user.id()){var t=Inffuse.user.plan()||"free",e=r.plans.find(function(e){return e.id===t});r.user={id:Inffuse.user.id(),accessToken:Inffuse.user.accessToken(),email:Inffuse.user.email(),name:Inffuse.user.name(),plan:t,planName:e&&e.name},ga&&ga("set","userId",Inffuse.user.key()),$zopim&&$zopim(function(){$zopim.livechat.setName(Inffuse.user.name()),$zopim.livechat.setEmail(Inffuse.user.email()),$zopim.livechat.addTags("Plan = "+Inffuse.user.plan()),$zopim.livechat.addTags("Inffuse ID = "+Inffuse.user.id()),$zopim.livechat.setNotes("http://dashboard.inffuse.com/app:emailjs/users/user:"+Inffuse.user.id())}),r.resetUser()}else r.user=null},r.logout=function(){Inffuse.user.logout().success(function(){r.updateUser(),$next=n.path(),n.url("/account/login").search("next",$next),r.$apply()})},r.onContactUs=function(e,t){var a={subject:e,message:t};Inffuse.user.id()&&(a.email=Inffuse.user.email(),a.name=Inffuse.user.name()),r.openDialog("contact",a)},r.upgradePlan=function(e){r.closeDialog(),n.url(r.UPGRADE_LINK)},r.cancelPlan=function(){r.onContactUs("Cancel account","Please cancel my account")},r.contactUs=function(e){return Inffuse.services.zendesk.submit(e.name,e.email,{subject:e.subject,message:e.message}).success(function(){r.closeDialog(),r.$apply()}).error(function(){console.error("send support FAILED. error=",err),e.error=err.text,r.$apply()})},r.filter=function(e,t,a){n.search(e,t==a?null:t)},r.sort_by=function(t,a,r){var n=r?function(e){return r(e[t])}:function(e){return e[t]};return a=a?-1:1,function(e,t){return e=n(e),t=n(t),a*((t<e)-(e<t))}},r.resetUser=function(){var n=r.CONFIG.server+"/api/v1.0/admin/reset";return new Promise(function(e,t){var a=new XMLHttpRequest;a.open("POST",n),a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.onload=function(){200==this.status?e({status:a.status,text:a.responseText}):t({status:a.status,text:a.responseText})},a.onerror=function(){t({status:a.status,text:a.responseText})};var r={user_id:Inffuse.user.id()};a.send(JSON.stringify(r))})},r.getTemplateKeys=function(e){if(!e)return[];var t=e.match(/{{\s*[\w\.]+\s*}}/g);return t?t.map(function(e){return e.match(/[\w\.]+/)[0]}).filter(function(e){return"user_os"!=e&&"user_platform"!=e&&"user_browser"!=e&&"user_version"!=e}):[]},r.updateUser()}angular.module("App",["ngRoute","ui.tinymce","ngAnimate","ngSanitize"]).controller("AppController",["$scope","$http","$timeout","$q","$location",AppController]).config(["$interpolateProvider",function(e){e.startSymbol("[["),e.endSymbol("]]")}]).config(["$routeProvider",configRouterProvider]).config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1}).hashPrefix("!")}]).run(["$rootScope",function(e){e.track=function(e,t,a){ga&&ga("send","event",e,t,a)}}]).run(["$rootScope","$location",function(n,s){n.$on("$routeChangeStart",function(e,t,a){var r=s.path();null==Inffuse.user.id()&&"/account/login"!=r&&"/account/create"!=r&&"/account/forgot_password"!=r&&"/account/reset_password"!=r&&"/contact"!=r&&s.path("/account/login").search("next",r),n.title=t.$$route.title,ga&&ga("send","pageview",{title:n.title,page:r})})}]).directive("asyncLoading",["$filter",function(){return{restrict:"A",priority:-1,link:function(r,n,s){function i(){var e=n.find(".async-loading-target");e.length||(e=n.find("button[type!=button]")),e.length||(e=n),n.addClass("loading"),e.addClass("async-loading-target"),e.append('<div class="spinner spinner-generated"></div>')}function o(){n.removeClass("loading"),n.find(".spinner-generated").remove()}var e,l;s.ngClick?(e="click",l="ngClick"):s.ngSubmit?(e="submit",l="ngSubmit"):s.ngInit&&(e="init",l="ngInit",setTimeout(function(){n.trigger("init")}));var t=r.$eval(s.asyncLoading||"{}");t.flag?r.$watch(t.flag,function(){r.$eval(t.flag)?i():o()}):n.on(e,function(e){e.preventDefault(),e.stopImmediatePropagation(),i();var t=s[l],a=r.$eval(t);a?(a.finally||a.always||a.then).apply(a,[function(){o()}]):!1===a&&(n.removeClass("loading"),n.find(".spinner").remove()),r.$apply()})}}}]).directive("confirm",["$filter",function(){return{priority:-1,scope:{ngClick:"&ngClick",ngSubmit:"&ngSubmit"},link:function(r,e,n){var t;n.ngClick?t="click":n.ngSubmit&&(t="submit"),e.on(t,function(e){if(e.preventDefault(),e.stopImmediatePropagation(),n.confirmEnable&&!$(this).scope().$eval(n.confirmEnable))return n.ngClick?r.ngClick.call():n.ngSubmit&&r.ngSubmit.call(),void $(this).scope().$apply();var t=r.$root.$on("_actionConfirmed",function(e){e.currentScope!==e.targetScope&&e.currentScope.$broadcast("_actionConfirmed")}),a=r.$on("_actionConfirmed",function(e){n.ngClick?e.currentScope.ngClick.call():n.ngSubmit&&e.currentScope.ngSubmit.call()});$(this).scope().openDialog("confirm",{title:n.confirm,onClose:function(){t(),a()}}),$(this).scope().$apply()})}}}]).directive("code",["$filter",function(){return{restrict:"E",priority:-1,link:function(e,t,a){setTimeout(function(){hljs.highlightBlock(t[0])})}}}]).directive("blockify",["$filter",function(){return{restrict:"A",priority:-1,link:function(e,t,a){!function e(t){if(-1==["STYLE","IFRAME"].indexOf(t.tagName)){if(t.nodeType==Node.TEXT_NODE){var a=t.textContent,r=a;if(a==(r=(r=(r=r.replace(/[^\s]/g,"▄")).replace(/(\S) (\S)/g,"$1&#8203;▄$2")).replace(/▄▄▄/g,"▄")))return;var n=document.createElement("div");return n.appendChild(t.cloneNode()),void(t.parentElement.innerHTML=t.parentElement.innerHTML.replace(n.innerHTML,'<span style="opacity:0.6; text-shadow: 0px 1px;">'+r+"</span>"))}for(var s=t.childNodes,i=0;i<s.length;i++)e(s[i])}}(t[0])}}}]).directive("buttonDropdown",["$compile",function(e){return{link:function(e,t,a){$(t).find(".arrow").click(function(e){e.stopPropagation(),e.preventDefault(),$(t).toggleClass("open")}),$("body").click(function(){$(t).removeClass("open")})}}}]).directive("pageSelect",["$compile",function(e){return{scope:{page:"=ngModel",ngChange:"&",isLastPage:"="},restrict:"E",template:'<a ng:click="page=page-1" class="arrow fa fa-angle-left" ng:class="{disabled: page<=1}"></a><span class="current-page" ng:model="page">[[page]]</span><a ng:click="page=page+1" class="arrow fa fa-angle-right" ng:class="{disabled: isLastPage}"></a>',link:function(a,e,t,r){a.$watch("page",function(e,t){e!==t&&a.ngChange&&a.ngChange()})}}}]).directive("editableField",["$compile","$timeout",function(e,t){return{restrict:"EA",scope:{ngModel:"=",ngChange:"&",validate:"&?"},link:function(n,s,e){function t(){var e=n.ngModel,t=$('<span class="value"></span>');null==e&&(e="<i>(not set)</i>"),t.text(e),s.empty(),s.append(t);var a=$('<a class="action icon onhover fa fa-pencil"></a>');a.click(r),s.append(a)}function r(){var e=n.ngModel,a=$('<span class="input" contenteditable="true"></span>');null==e&&(e=""),a.text(e),s.addClass("editing"),s.empty(),s.append(a);var t=$('<a class="action icon fa fa-check"></a>');s.append(t);var r=$('<i class="icon error fa fa-exclamation-circle"></i>');s.append(r),t.mousedown(function(e){o(e)}),a.blur(function(){setTimeout(i,0)}),n.validate&&a.keyup(function(){null==n.validate({value:a.text()})?s.removeClass("error"):s.addClass("error")}),setTimeout(function(){var e=document.createRange();e.selectNodeContents(a[0]);var t=window.getSelection();t.removeAllRanges(),t.addRange(e),a.focus()}),l=!0}function i(){l&&(t(),l=!1,s.removeClass("editing"))}function o(e){e.stopPropagation();var t=s.parents("form:first");if(t.length){var a=t.attr("name");t.scope().$eval(a).$setDirty()}n.ngModel=s.find(".input").text(),n.$digest(),i(),n.ngChange&&n.ngChange.call()}var l=!1;s.click(function(e){e.stopPropagation(),l||r()}),s.keydown(function(e){switch(e.keyCode){case 13:o(e);break;case 27:i()}}),t(),n.$watch("ngModel",function(){t()})}}}]).filter("unsafe",["$sce",function(t){return function(e){return t.trustAsHtml(e)}}]).run(["$templateCache","$http",function(e,t){for(var a=["code","add_service","confirm","contact","create_template","default_service","error","service_details","test_mail","test_template","update_user_psw","upgrade","template_help","smtp_service_details","resend"],r=0;r<a.length;r++)t.get("/html/dialogs/"+a[r]+".html",{cache:e})}]).run(["$rootScope","$location",function(r,n){var s=!1,i=null;r.allowNavigation=function(){s=!1},r.preventNavigation=function(){s=!0,i=n.absUrl()},r.$on("$locationChangeStart",function(e,t,a){i==a&&null!=i?(s&&!confirm("You have unsaved changes, do you want to continue?")?e.preventDefault():r.allowNavigation(),window.onbeforeunload=function(){if(s&&n.absUrl()==i)return"You have unsaved changes, do you want to continue?"}):r.allowNavigation()})}]);var InffuseSDK=new InffuseSDK_01("emailjs");function HomeCtrl(t,e,a,r,n){t.loadRecentLogs=function(){return t.loadLogs(3).then(function(e){t.loading=!1,t.log_history=e},function(){console.error(status,data),t.loading=!1,t.log_history=null})},t.init=function(){}}function ServicesCtrl(l,r,e,t){function c(e,t){var a=l.CONFIG.server+"/api/v1.0/email/test";return r.post(a,{to:t,user_id:Inffuse.user.id(),accessToken:Inffuse.user.accessToken(),service:e})}l.init=function(){},l.disconnectGmail=function(e){Inffuse.services.google.disconnect().always(function(){e.refresh_token=null,e.access_token=null,e.connected=!1,l.$apply()})},l.connectGmail=function(r){l.track("Service","Gmail","Connect"),Inffuse.services.google.connect("https://www.googleapis.com/auth/gmail.send,https://www.googleapis.com/auth/userinfo.email",function(e){var t=e.tokens.refresh_token,a=e.tokens.access_token;if(void 0===t||!t||void 0===a||!a)return console.error("Error connecting to Gmail. Bad tokens."),void l.track("Service","Gmail","Failed");r.refresh_token=t,r.access_token=a,r.email=e.user.email,r.connected=!0,l.$apply(),l.track("Service","Gmail","Connected")})},l.onSelectDefaultService=function(){l.openDialog("default_service",{id:l.data.settings.default_service})},l.selectDefaultService=function(e){l.data.settings.default_service=e.id,l.closeDialog(),l.$apply(),l.track("Service","Default service changed")},l.onAddService=function(){l.openDialog("add_service")},l.addService=function(e){var t={service:{provider:e.provider},provider:e,add_button_text:"Add Service"};"SMTP"==e.provider?l.openDialog("smtp_service_details",t):l.openDialog("service_details",t)},l.onUpdateservice=function(e,t){var a={index:e,service:l.clean(t),provider:l.SERVICES_INFO[t.provider],add_button_text:"Update Service"};"SMTP"==a.provider.provider?l.openDialog("smtp_service_details",a):l.openDialog("service_details",a)},l.saveService=function(t){var a,e,r=void 0===t.index;if(t.error="",t.test_error="",t.service.id===l.DEFAULT_SERVICE_ID)return t.error='"'+t.service.id+'" is a reserved ID',!1;if(r&&(a=t.service.id,0!=(e=l.data.services.filter(function(e){return e.id==a})).length&&e[0]))return!(t.error="Service with this Service ID already exists");var n={id:t.service.id,name:t.service.name,provider:t.service.provider||t.provider.provider,connected:t.service.connected};switch(n.provider){case"SMTP":n.host=t.service.host,n.port=t.service.port,n.secure=t.service.secure,n.email=t.service.email,n.password=t.service.password;break;case"Postmark":case"Mandrill":n.api_key=t.service.api_key;break;case"Mailgun":n.api_key=t.service.api_key,n.domain=t.service.domain,n.region=t.service.region;break;case"Mailjet":n.api_key=t.service.api_key,n.secret_key=t.service.secret_key;break;case"SES":n.access_key=t.service.access_key,n.secret_key=t.service.secret_key,n.region=t.service.region;break;case"SendGrid":if(n.api_key=t.service.api_key,n.asm_group_id=t.service.asm_group_id,n.asm_groups_to_display=t.service.asm_groups_to_display,n.header=[],"string"!=typeof t.service.asm_group_id||isNaN(parseInt(t.service.asm_group_id))||n.header.push({key:"asm_group_id",value:parseInt(t.service.asm_group_id)}),"string"==typeof t.service.asm_groups_to_display){for(var s=t.service.asm_groups_to_display.split(","),i=[],o=0;o<s.length;o++)isNaN(parseInt(s[o]))||i.push(parseInt(s[o]));n.header.push({key:"asm_groups_to_display",value:i})}break;case"Gmail_API":if(r&&!t.service.connected)return!(t.error="Please connect your Gmail account");n.email=t.service.email,n.refresh_token=t.service.refresh_token,n.access_token=t.service.access_token,n.connected=t.service.connected;break;default:n.email=t.service.email,n.password=t.service.password}if(t.sendTestMail)return c(n).then(function(e){r?(l.data.services.push(n),1==l.data.services.length&&(l.data.settings.default_service=n.id),l.track("Service","Added",n.provider)):(l.data.services[t.index].id==l.data.settings.default_service&&(l.data.settings.default_service=n.id),l.data.services[t.index]=n,l.track("Service","Updated",n.provider)),l.closeDialog()},function(e){t.test_error=e.data?e.data.message||e.data:"None"});r?(l.data.services.push(n),1==l.data.services.length&&(l.data.settings.default_service=n.id),l.track("Service","Added",n.provider)):(l.data.services[t.index].id==l.data.settings.default_service&&(l.data.settings.default_service=n.id),l.data.services[t.index]=n,l.track("Service","Updated",n.provider)),l.closeDialog(),l.$apply()},l.deleteService=function(e){var t=l.data.services[e].id;l.data.settings.default_service,l.data.services.splice(e,1),1<=l.data.services.length?l.data.settings.default_service=l.data.services[0].id:l.data.settings.default_service=null,l.track("Service","Deleted")},l.onTestEmail=function(e){if("Gmail"==e.provider&&!e.connected)return l.showError("Test error","Gmail service is not connected.<br><br>Please connect the Gmail service first through the service settings dialog.");l.openDialog("test_mail",e)},l.testEmail=function(t,e){return t.result="",t.error="",c(t,e).then(function(){t.result="OK",l.$apply(),l.track("Service","Test","Success")},function(e){console.error(e.status,e.text),t.error=e.text,l.$apply(),l.track("Service","Test","Failure: "+e.text)})}}function EmailTemplatesCtrl(t,r,e,n,a,s){r.templates=t,r.reloadTemplates=function(){Inffuse.user.getDataStore().loadData("templates").then(function(e){r.templates=e.value,r.$apply()}).fail(function(e){console.error("ERROR load templates:",e)})},r.deleteTemplate=function(a){r.dataStore.loadData("templates").then(function(e){var t=e.value;t=t.filter(function(e){return e.system_id!=a.system_id}),r.dataStore.set("templates",t).done(r.reloadTemplates),r.track("Template","Deleted"),r.$apply()}).fail(function(e){console.error("ERROR load templates:",e)})},r.onAddTemplate=function(e){t.length>=r.max_templates?r.openDialog("upgrade",{message:"Please upgrade to add more templates.",type:"templates_count"}):r.openDialog("create_template")},r.createTemplate=function(a){r.dataStore.loadData("templates").then(function(e){var t=e.value;a.system_id=r.generateID(10),t.push(a),r.dataStore.set("templates",t).then(function(){r.resetUser(),r.track("Template","Added"),n.url("/templates/"+a.system_id),r.$apply()})}).fail(function(e){console.error("ERROR load templates:",e)}),r.closeDialog()},r.duplicateTemplate=function(e){t.length>=r.max_templates?r.openDialog("upgrade",{message:"Please upgrade to add more templates.",type:"templates_count"}):(r.closeDialog(),n.url(n.url()+"/id:new?from_id="+e)),r.track("Template","Duplicated")},r.validateTemplateId=function(e){if("new"==e)return'"new" is a reserved id';var t=s.from_id||s.system_id,a=findTemplateByTemplateId(e);if("new"==t){if(a)return e+" is already used"}else if(a&&a.system_id!==r.template.system_id)return e+" is already used";return!1},r.showUpgradeDialog=function(e,t){r.openDialog("upgrade",{message:e,type:t})}}function EmailTemplateCtrl(o,g,i,l,e,r){function c(t){var e=o.filter(function(e){return e.id==t});return 0==e.length?null:e[0]}function n(t){var e=o.filter(function(e){return e.system_id==t});return 0==e.length?null:e[0]}g.CONTENT_TYPES=[{key:"",label:"Filename extension (Default)"},{key:"image/png",label:"PNG (Image)"},{key:"image/gif",label:"GIF (Image)"},{key:"image/jpeg",label:"JPEG (Image)"},{key:"image/svg+xml",label:"SVG (Image)"},{key:"application/pdf",label:"PDF (File)"},{key:"text/csv",label:"CSV (File)"},{key:"application/json",label:"JSON (File)"},{key:"application/xml",label:"XML (File)"},{key:"application/xhtml+xml",label:"XHTML (File)"},{key:"text/html",label:"HTML (File)"},{key:"text/plain",label:"TXT (File)"},{key:"application/zip",label:"ZIP (Archive)"},{key:"application/gzip",label:"GZIP (Archive)"},{key:"application/mp4",label:"MP4 (Multimedia)"},{key:"application/mpeg",label:"MPEG (Multimedia)"},{key:"model/mesh",label:"MESH (3D Model)"}],g.$watch("email_template_form.$dirty",function(e){e?g.preventNavigation():g.allowNavigation()}),g.template,g.test_params_json={},g.attachment_loading=[],g.findTemplateIndex=function(e){var t=-1;if(void 0!==e&&e)for(var a=0;a<o.length;a++)if(o[a].system_id==e){t=a;break}return t},g.saveMetaOnly=function(e,t){e.meta_only=t,g.track("Template","Metadata only",t)},g.contentChanged=function(e,t){e.text=angular.element(t).text()},g.autoReplyContentChanged=function(e,t){e.auto_reply_params.text=angular.element(t).text()},g.initTemplate=function(){var e=null,t=r.from_id;if(t?(e=g.clone(n(t)))&&(delete e.system_id,e.id=e.id+"_clone"):e=n(r.system_id),e)e.meta_only=!!e.meta_only,e.attachments=e.attachments||[],e.static_attachments=e.static_attachments||[],g.template=g.clone(e);else if(r.design){var a=r.design;i.get("/code/designs/"+g.TEMPLATE_DESIGNS[a].template).success(function(e){g.template={content:e},g.template.attachments=[],g.template.static_attachments=[],g.template.use_default_from_email=!0})}},g.save_captcha_site_key=function(e){var t=g.findTemplateIndex(e.system_id);0<=t&&o[t].captcha_site_key!==e.captcha_site_key&&(o[t].captcha_site_key=e.captcha_site_key),g.template=g.clone(e)},g.onCopyCode=function(e){var t=g.extractDynamicVars(g.template);t.length&&((t=t.map(function(e){return'&nbsp;&nbsp;&nbsp;"'+e+'": "'+e+'_value",'}))[t.length-1]=t[t.length-1].slice(0,-1));var a=[];a.push("var template_params = {"),a.push.apply(a,t),a.push("}"),a.push(""),a.push('var service_id = "default_service";'),a.push('var template_id = "'+e.id+'";'),a.push("emailjs.send(service_id, template_id, template_params);"),a=a.join("<br>"),g.openDialog("code",{template:e,code:a})},g.onTestTemplate=function(e,t,a,r){return g.data.services.length<1?g.showError("No service found","Please add a service!"):(e.dirty=!1,void 0!==t&&t&&(e.dirty=!0),"local"==a?g.openDialog("test_template",e):e.captcha?e.captcha_secret?g.openDialog("captcha_site_key",{template:e,jsfiddle_type:r}):g.showError("Captcha secret key missing","Please add your reCAPTCHA secret key"):g.test(e,r)),!1},g.testTemplate=function(t){var a={};if(t.result=null,t.error=null,t.json_error=null,!t||!t.test_params||!t.test_params.service_id)return t.error="Please select a Service",g.$apply(),!1;if(t.test_params.json)try{a=JSON.parse(t.test_params.json)}catch(e){a=t.test_params.json}var e=t.test_params.service_id,r=t.id,n={service_id:e,json:t.test_params.json},s=g.findTemplateIndex(t.system_id);0<=s&&(o[s].test_params=n,g.template&&(g.template.test_params=n),g.$apply());var i=angular.element(".g-recaptcha-response").val();return i&&(a["g-recaptcha-response"]=i),g.emailjs.send(e,r,a).then(function(e){t.result="OK",g.refreshQuota(),g.$apply(),g.track("Template","Test template","Success")},function(e){console.error("send FAILED. error=",e),t.error=e.text,g.$apply(),g.track("Template","Test template","Failure")})},g.extractDynamicVars=function(e){g.test_params_json={};var t=[],a=[];if(t=(t=(t=(t=(t=(t=(t=(t=g.getTemplateKeys(e.to_email)).concat(g.getTemplateKeys(e.from_name))).concat(g.getTemplateKeys(e.from_email))).concat(g.getTemplateKeys(e.reply_to))).concat(g.getTemplateKeys(e.cc))).concat(g.getTemplateKeys(e.bcc))).concat(g.getTemplateKeys(e.subject))).concat(g.getTemplateKeys(e.content)),0<e.attachments.length)for(var r=0;r<e.attachments.length;r++){var n=e.attachments[r];"upload"===n.type&&(a=a.concat(n.input_name)),"inline"===n.type&&(g.test_template_has_inline_attachments=!0,t=(t=t.concat(g.getTemplateKeys(n.filename))).concat(g.getTemplateKeys(n.content))),"url"===n.type&&(g.test_template_has_inline_attachments=!0,t=t.concat([n.variable]))}return function(e){for(var t=e.concat(),a=0;a<t.length;++a)for(var r=a+1;r<t.length;++r)t[a]===t[r]&&t.splice(r--,1);return t}(t)},g.test=function(e,t){var a=[];a=(a=(a=(a=(a=(a=(a=(a=g.getTemplateKeys(e.to_email)).concat(g.getTemplateKeys(e.from_name))).concat(g.getTemplateKeys(e.from_email))).concat(g.getTemplateKeys(e.reply_to))).concat(g.getTemplateKeys(e.cc))).concat(g.getTemplateKeys(e.bcc))).concat(g.getTemplateKeys(e.subject))).concat(g.getTemplateKeys(e.content));for(var r=e.attachments.filter(function(e){return"inline"===e.type||"url"===e.type})||[],n=0;n<r.length;n++)"url"===r[n].type&&(a=a.concat([r[n].variable])),"inline"===r[n].type&&(a=(a=a.concat(g.getTemplateKeys(r[n].filename))).concat(g.getTemplateKeys(r[n].content)));a=function(e){for(var t=e.concat(),a=0;a<t.length;++a)for(var r=a+1;r<t.length;++r)t[a]===t[r]&&t.splice(r--,1);return t}(a);var s=[],i=[],o=[],l="'"+e.id+"'",c="'default_service'",p='<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@2.3.2/dist/email.min.js"><\/script>',u='      emailjs.init("'+Inffuse.user.id()+'");';switch(t){case"inline":case"url":if(0<e.attachments.length?s.push('<form id="myform" enctype="multipart/form-data" onsubmit="emailjs.sendForm('+c+", "+l+', this); return false;" method="post">'):s.push('<form id="myform" onsubmit="emailjs.sendForm('+c+", "+l+', this); return false;" method="post">'),0<a.length)for(n=0;n<a.length;n++){var d="<label>"+a[n]+"</label>";s.push(d),g.test_params_json[a[n]]?s.push('<input type="text" name="'+a[n]+'" value="'+g.test_params_json[a[n]]+'" />'):s.push('<input type="text" name="'+a[n]+'" />')}else s.push("No dynamic variables in this template.<br>");if(0<e.attachments.length)for(n=0;n<e.attachments.length;n++)"upload"==e.attachments[n].type&&(0==n?s.push("<label>Attachments</label>"):s.push("<label>Attachments_"+n+"</label>"),s.push('<input name="'+e.attachments[n].input_name+'" type="file" multiple/>'));0<r.length&&(s.push("<br><br><b>This template contains inline attachments.</b><br>"),s.push("Inline attachment content can be in <b>base64</b> encoding or <b>URL</b>.<br>"),s.push('See <a href="https://www.emailjs.com/docs/user-guide/file-attachments/inline-content-example/" target="_blank">documentation</a> for canvas example.<br>')),e.captcha&&e.captcha_secret&&e.captcha_site_key&&(g.save_captcha_site_key(e),s.push(""),s.push('<script src="https://www.google.com/recaptcha/api.js"><\/script>'),s.push('<div class="g-recaptcha" data-sitekey="'+e.captcha_site_key+'"></div>'),s.push("")),s.push("<br><br>"),s.push("<button>"),s.push("Send"),s.push("</button>"),s.push("</form>"),s.push(""),s.push(p),s.push('<script type="text/javascript">'),s.push("   (function(){"),s.push(u),s.push("   })();"),s.push("<\/script>"),s.push(""),i=s.join("\r\n");break;case"send":if(s.push('<form id="myform">'),0<a.length)for(n=0;n<a.length;n++){d="<label>"+a[n]+"</label>";s.push(d),g.test_params_json[a[n]]?s.push('<input type="text" name="'+a[n]+'" value="'+g.test_params_json[a[n]]+'" />'):s.push('<input type="text" name="'+a[n]+'" />')}else s.push("No dynamic variables in this template.<br>");0<r.length&&(s.push("<br><br><b>This template contains inline attachments.</b><br>"),s.push("Inline attachment content can be in <b>base64</b> encoding or <b>URL</b>.<br>"),s.push('See <a href="https://www.emailjs.com/docs/user-guide/file-attachments/inline-content-example/" target="_blank">documentation</a> for canvas example.<br>')),e.captcha&&e.captcha_secret&&e.captcha_site_key&&(g.save_captcha_site_key(e),s.push(""),s.push('<script src="https://www.google.com/recaptcha/api.js"><\/script>'),s.push('<div class="g-recaptcha" data-sitekey="'+e.captcha_site_key+'"></div>'),s.push("")),s.push("<br><br>"),s.push("<button>"),s.push("Send"),s.push("</button>"),s.push("</form>"),s.push(""),s.push('<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"><\/script>'),s.push(""),s.push(p),s.push('<script type="text/javascript">'),s.push("   (function(){"),s.push(u),s.push("   })();"),s.push("<\/script>");i=s.join("\r\n");o=['var myform = $("form#myform");',"myform.submit(function(event){","\tevent.preventDefault();","","\tvar params = myform.serializeArray().reduce(function(obj, item) {","     obj[item.name] = item.value;","     return obj;","  }, {});","","  // Change to your service ID, or keep using the default service",'  var service_id = "default_service";',"",'  var template_id = "'+e.id+'";','  myform.find("button").text("Sending...");',"  emailjs.send(service_id, template_id, params)","  \t.then(function(){ ",'       alert("Sent!");','       myform.find("button").text("Send");',"     }, function(err) {",'       alert("Send email failed!\\r\\n Response:\\n " + JSON.stringify(err));','       myform.find("button").text("Send");',"    });","","  return false;","});"].join("\r\n");break;case"sendForm":if(0<e.attachments.length?s.push('<form id="myform" enctype="multipart/form-data" method="post">'):s.push('<form id="myform" method="post">'),0<a.length)for(n=0;n<a.length;n++){d="<label>"+a[n]+"</label>";s.push(d),g.test_params_json[a[n]]?s.push('<input type="text" name="'+a[n]+'" value="'+g.test_params_json[a[n]]+'" />'):s.push('<input type="text" name="'+a[n]+'" />')}else s.push("No dynamic variables in this template.<br>");if(0<e.attachments.length)for(n=0;n<e.attachments.length;n++)"upload"==e.attachments[n].type&&(0==n?s.push("<label>Attachments</label>"):s.push("<label>Attachments_"+n+"</label>"),s.push('<input name="'+e.attachments[n].input_name+'" type="file" multiple/>'));0<r.length&&(s.push("<br><br><b>This template contains inline attachments.</b><br>"),s.push("Inline attachment content can be in <b>base64</b> encoding or <b>URL</b>.<br>"),s.push('See <a href="https://www.emailjs.com/docs/user-guide/file-attachments/inline-content-example/" target="_blank">documentation</a> for canvas example.<br>')),e.captcha&&e.captcha_secret&&e.captcha_site_key&&(g.save_captcha_site_key(e),s.push(""),s.push('<script src="https://www.google.com/recaptcha/api.js"><\/script>'),s.push('<div class="g-recaptcha" data-sitekey="'+e.captcha_site_key+'"></div>'),s.push("")),s.push("<br><br>"),s.push("<button>"),s.push("Send"),s.push("</button>"),s.push("</form>"),s.push(""),s.push('<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"><\/script>'),s.push(""),s.push(p),s.push('<script type="text/javascript">'),s.push("   (function(){"),s.push(u),s.push("   })();"),s.push("<\/script>");i=s.join("\r\n");o=["",'var myform = $("form#myform");',"myform.submit(function(event){","\tevent.preventDefault();","","  // Change to your service ID, or keep using the default service",'  var service_id = "default_service";','  var template_id = "'+e.id+'";',"",'  myform.find("button").text("Sending...");',"  emailjs.sendForm(service_id,template_id,myform[0])","  \t.then(function(){ ",'    \talert("Sent!");','       myform.find("button").text("Send");',"    }, function(err) {",'       alert("Send email failed!\\r\\n Response:\\n " + JSON.stringify(err));','       myform.find("button").text("Send");',"    });","  return false;","});"].join("\r\n")}var m=["body {","  font-family: arial;","  font-size: 12px;","  color: #666;","}","form {","  width: 500px;","  background: white;","  padding: 20px 25px;","  margin: auto;","  margin-top: 30px;","  box-shadow: 0px 1px 2px rgba(0,0,0,0.2);","}","form input,","form textarea {","  font: inherit;","  padding: 5px 5px;","  width: 100%;","  margin-top: 3px;","  margin-bottom: 15px;","  box-sizing: border-box;","}","form button {","  border: 1px solid rgba(0,0,0,0.2);","  padding: 8px 35px;","  font-size: 12px;","  background: #888;","  color: white;","}","form label {","  color: #777;","  font-size: 11px;","  margin-bottom: 2px;","  display: block;","}"],f=[];if("inline"==t)f=["form:after {","  content: '';","  position: absolute;","  left: 3px;","  top: 3px;","  right: 3px;"," box-shadow: 0px 2px 3px rgba(0,0,0,0.2);","  text-shadow: 1px 1px white;","  font-size: 11px;"," padding: 18px;","  text-align: center;","  box-sizing: border-box;","  margin-top: -100px;","  transition: all .3s;","}","form.emailjs-success:after,","form.emailjs-sending:after,","form.emailjs-error:after {","  margin-top: 0;","  transition: all .3s;","}","form.emailjs-sending:after {","  content: 'Sending email...';","  background: #eee;","}","form.emailjs-success:after {","  content: 'Email sent!';","  background: #1B5E20;","  color: white;","  text-shadow: -1px -1px black;","}","form.emailjs-error:after {","  content: 'Error sending email';","  background: #B71C1C;","  color: white;","  text-shadow: -1px -1px black;","}"];var h={code:i,js:o,css:m=m.concat(f).join("\r\n"),title:"Test template "+e.id,description:"Sample code for sending your template"};$("#html").val(h.code),$("#js").val(h.js),$("#css").val(h.css),$("#title").val(h.title),$("#description").val(h.description),$("#panel_html").val(0),$("#panel_js").val(0),$("#panel_css").val(0),$("#wrap").val("l"),$("#jsfiddle-form").submit(),g.track("Template","Open JSFiddle",t)},g.validateTemplateId=function(e){if("new"==e)return'"new" is a reserved id';var t=r.from_id||r.system_id,a=c(e);if("new"==t){if(a)return e+" is already used"}else if(a&&a.system_id!==g.template.system_id)return e+" is already used";return!1},g.saveTemplate=function(s,i){return g._saving=!0,g.dataStore.loadData("templates").then(function(e){o=e.value;var t=g.validateTemplateId(s.id);if(t)i._idError=t,alert(s.id+" is already used"),g._saving=!1,g.$apply();else{delete s.dirty,s.static_attachments=function(e){if(!e||!e.length)return e;for(var t=[],a=0;a<e.length;++a)e[a]&&t.push(e[a]);return t}(s.static_attachments);var a=g.findTemplateIndex(s.system_id);if(0<=a){(n=c(s.id))&&n.system_id!==s.system_id&&(alert(n.id+" is already used"),g.template.id=o[a].id,g.$apply()),o[a]=g.clean(s),g.$apply();var r=g.clean(o);g.dataStore.set("templates",r).then(function(){g.resetUser(),g.track("Template","Updated"),i.email_template_form.$setPristine(),g._saving=!1,g.$apply()})}else{var n;"new"==(n=g.clean(s)).id&&alert('"new" is a reserved id'),c(n.id)&&(alert(n.id+" is a already used"),n.id=""),n.system_id=g.generateUniqueId(),o.push(n),g.$apply();r=g.clean(o);g.dataStore.set("templates",r).then(function(){g.resetUser(),g.track("Template","Added"),i.email_template_form.$setPristine(),l.url("/templates/"+n.system_id),g._saving=!1,g.$apply()})}}}).fail(function(e){console.error("ERROR load templates:",e),g._saving=!1}),!1},g.uploadStaticAttachment=function(n){var s=parseInt(n.attributes.index.value),e=n.attributes.template.value,t=n.files[0];if(t){Inffuse.user.id(),Inffuse.user.accessToken();var a=new FormData;a.append("file",t),a.append("template_id",e),a.append("user_id",Inffuse.user.id()),a.append("accessToken",Inffuse.user.accessToken()),g.attachment_loading[s]=!0;var r=g.CONFIG.server+"/api/v1.1/upload";i.post(r,a,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(e){g.template.static_attachments=g.template.static_attachments||[],g.attachment_loading[s]=!1;for(var t=0,a=0;a<g.template.static_attachments.length;a++)t+=g.template.static_attachments[a]?g.template.static_attachments[a].size:0;var r=e.size+t;"basic"==g.user_plan&&512e3<r?g.openDialog("upgrade",{message:"Max total attachments size for your plan is 500kb",type:"upgrade"}):"professional"==g.user_plan&&2048e3<r?g.openDialog("upgrade",{message:"Max total attachments size for your plan is is 2mb",type:"upgrade"}):2048e4<r?g.openDialog("upgrade",{message:"Max total attachments size is 20mb",type:"upgrade"}):(g.template.static_attachments[s]=e,g.email_template_form.$dirty=!0,n.value=null)}).error(function(e){g.attachment_loading[s]=!1,console.error("File upload returned error: ",e)})}},g.showUpgradeDialog=function(e,t){g.openDialog("upgrade",{message:e,type:t})},g.removeStaticAttachment=function(e,t){g.template.static_attachments.splice(t,1),e.$dirty=!0,g.track("Template","Static Attachment","Deleted")},g.addAttachment=function(e){"free"!=g.user_plan?(g.template.attachments.push({type:"upload"}),e.$dirty=!0,g.track("Template","Dynamic Attachment","Added")):g.openDialog("upgrade",{message:"Please upgrade to enable attachments.",type:"attachments"})},g.addStaticAttachment=function(e){"free"!=g.user_plan?(g.template.static_attachments.push(null),e.$dirty=!0,g.track("Template","Static Attachment","Added")):g.openDialog("upgrade",{message:"Please upgrade to enable attachments.",type:"attachments"})},g.removeAttachment=function(e,t){g.template.attachments.splice(t,1),e.$dirty=!0,g.track("Template","Dynamic Attachment","Deleted")},g.isUploadAttachment=function(e){return!(!e||!e.attachments)&&"object"==typeof e.attachments.filter(function(e){return"upload"===e.type})[0]},g.validateId=function(e){var t=c(e);return t&&t.system_id!=g.template.system_id?"Template ID is already in use":null}}function UserCtrl(s,e,r,n,i,o){function l(e){if(e)return e.toLowerCase()}s.initPlans=function(){s.plans.forEach(function(e){Inffuse.user.plan()==e.id&&(e.action={type:"current"})})},s.login=function(e,t){return s.error=null,Inffuse.user.login(l(e),t).success(function(e){ga&&ga("set","userId",Inffuse.user.key()),s.track("User","Login"),o(function(){n.location=r.search().next||"/"},300)}).error(function(e){s.error=e.responseJSON.error,s.updateUser(),s.$apply(),s.track("User","Login error",s.error)})},s.forgot_password=function(e){return s.error=null,Inffuse.user.resetPasswordRequest(l(e)).done(function(e){s.forgot_success=!0,s.$apply()}).fail(function(e){s.error=e.responseJSON.error,s.$apply()}),!1},s.resetPassword=function(e,t){if(s.error=null,e!==t)return s.error="Password don't match",void s.$apply();var a=i.emailjs_user,r=i.token,n=e;return Inffuse.user.resetPassword(a,n,r).done(function(e){s.reset_success=!0,s.$apply()}).fail(function(e){s.error=e.responseJSON.error,s.$apply()}),!1},s.createAccount=function(e,t,a){return s.error=null,Inffuse.user.create(e,l(t),a,grecaptcha.getResponse()).success(function(e){ga&&ga("set","userId",Inffuse.user.key()),s.track("User","Sign up"),o(function(){n.location=r.search().next||"/"},300)}).error(function(e){s.error=e.responseJSON.error,s.updateUser(),s.$apply(),s.track("User","create error",s.error)})},s.updateUserParameters=function(e,t){return s.error=null,Inffuse.user.update({name:e.name,email:l(e.email)}).success(function(e){t.$setPristine(),s.track("User","Details updated"),s.updateUser(),s.$apply()}).error(function(e){void 0!==e.responseJSON.error?s.error=e.responseJSON.error:s.error="Unhandled error while updating user parameters!",s.$apply()})},s.onUpdatePassword=function(){s.openDialog("update_user_psw")},s.updateUserPassword=function(a,r){return a.password!==a.password_repeat?!(a.error="New password doesn't match the retyped password!"):Inffuse.user.update({password:a.password,current_password:a.current_password}).success(function(e){for(var t in r.$setPristine(),a)delete a[t];s.track("User","Password updated"),s.updateUser(),s.$apply()}).error(function(e){void 0!==e.responseJSON.error?a.error=e.responseJSON.error:a.error="Unhandled error while updating user password!",s.$apply()})},s.choosePlan=function(e,t){s.free_user?(window.open(Inffuse.fastspring.renderUrl(e.pricing[t].checkout_page)),s.track("Plan",e.name)):e.id?s.onContactUs("Switch account","Please switch my account to "+e.name):s.onContactUs("Cancel account","Please cancel my account")}}function EmailHistoryCtrl(s,n,e,t,a){s.current_page=1,s.page_length=50,s.isLastPage=!0,s.count_start=0,s.template_filters=[],s.service_filters=[],s.resend_service_filters=[],s.result_filters=[{label:"Any Result"},{param:{key:"result",value:1},label:"Success"},{param:{key:"errors_only",value:!0},label:"Errors"}],s.filter_template="",s.resend_service="",s.filter_service="",s.filter_result=s.result_filters[0],s.filter_only_errors=!1,s.filter_retries=0,s.resend_service_filter="",s.rows=[],s.results={1:"OK",2:"Service Error"},s.loading=!1,s.$watch("selectAll",function(){angular.forEach(s.rows,function(e){e.selected=s.selectAll}),s.track("History","Select All")}),s.init=function(){s.reset_filters(),s.refresh()},s.reset_filters=function(){s.template_filters=[];for(var e=0;e<s.data.templates.length;e++)s.template_filters.push({id:s.data.templates[e].id,name:s.data.templates[e].name});s.service_filters=[];for(e=0;e<s.data.services.length;e++)s.service_filters.push({id:s.data.services[e].id,name:s.data.services[e].name});s.resend_service_filters=[];for(e=0;e<s.data.services.length;e++)s.resend_service_filters.push({id:s.data.services[e].id,name:s.data.services[e].name})},s.refresh=function(){s.loading=!0;var e={user_id:Inffuse.user.id(),accessToken:Inffuse.user.accessToken(),page:s.current_page,count:s.page_length};s.filter_template&&(e.template_id=s.filter_template),s.filter_service&&(e.service_id=s.filter_service),0<s.filter_retries&&(e.min_retry_count=s.filter_retries),s.filter_result.param&&(e[s.filter_result.param.key]=s.filter_result.param.value);var t=s.CONFIG.server+"/api/v1.1/history?"+$.param(e);return n.get(t).success(function(e,t,a,r){s.loading=!1,s.rows=e.rows;for(var n=0;n<s.rows.length;n++)s.rows[n].template_params=s.safeParse(s.rows[n].template_params),s.rows[n].files=s.safeParse(s.rows[n].files);s.count_start=(s.current_page-1)*s.page_length,s.isLastPage=e.is_last_page,s.selectAll=!1}).error(function(e,t,a,r){s.loading=!1,s.selectAll=!1,console.error("list email history FAILED. status=%d, error=%s",t,e),s.rows=[],s.current_page=1,s.page_length=50,s.isLastPage=!0,s.count_start=0})},s.selectedCount=function(){return s.rows.reduce(function(e,t){return e+(t.selected?1:0)},0)},s.del=function(e){return s.track("History","Delete"),s._deleteInProgress=!0,s.deleteEmail(e).then(function(){s.refresh().then(function(){s._deleteInProgress=!1})},function(e){console.error("Error found. status: %d, error: %s",e.status,e.data.error)})},s.removeList=function(){var e=[];s._deleteInProgress=!0;for(var t=0;t<s.rows.length;++t)s.rows[t].selected&&e.push(s.rows[t].id);return s.track("History","Delete bundle"),s.deleteEmails(e).then(function(){s.refresh().then(function(){s._deleteInProgress=!1})},function(e){console.error("Error found. status: %d, error: %s",e.status,e.data.error)})},s.deleteEmail=function(e){var t=$.param({user_id:Inffuse.user.id(),accessToken:Inffuse.user.accessToken()}),a=s.CONFIG.server+"/api/v1.1/history/"+e+"?"+t;return n.delete(a)},s.deleteEmails=function(e){var t=$.param({user_id:Inffuse.user.id(),accessToken:Inffuse.user.accessToken()}),a=s.CONFIG.server+"/api/v1.0/history/bucket/"+e+"?"+t;return n.delete(a)},s.resend=function(n){s.openDialog("resend",{services:s.service_filters,callback:function(e){var a,t=[];if(n)t.push(s.resendEmail(n,e));else for(var r=0;r<s.rows.length;r++)s.rows[r].selected&&t.push(s.resendEmail(s.rows[r].id,e));return a=Promise.all(t).catch(function(e){console.error("Error found. status: %d, error: %s %s",e.status,e.data.error,e.data.service_error)}),s.track("History","Resend"),new Promise(function(e,t){a.then(function(){s.refresh().then(function(){s.closeDialog(),s.refreshQuota(),e()})})})}})},s.resendEmail=function(e,t){var a={user_id:Inffuse.user.id(),accessToken:Inffuse.user.accessToken(),id:e};t&&(a.service_id=t);var r=s.CONFIG.server+"/api/v1.1/email/resend";return n.post(r,a)},s.select=function(e,t){t.stopImmediatePropagation(),e.selected=!e.selected}}function LogsCtrl(a){a.current_page=1,a.page_length=50,a.isLastPage=!0,a.count_start=0,a.rows=[],a.filter_email_id="",a.loading=!1,a.init=function(){a.refresh()},a.checked=function(e){a.filter_errors_only=e,a.refresh()},a.refresh=function(){return a.loading=!0,a.ListLogs().then(function(e){a.loading=!1;var t=JSON.parse(e.text);a.rows=t.rows,a.isLastPage=t.is_last_page,a.count_start=(a.current_page-1)*a.page_length,a.$apply()},function(e){a.loading=!1,console.error("list events FAILED. error=",e),a.$apply()})},a.ListLogs=function(){var e={user_id:Inffuse.user.id(),accessToken:Inffuse.user.accessToken(),page:a.current_page,count:a.page_length};a.filter_errors_only&&(e.errors_only=a.filter_errors_only);var r=a.CONFIG.server+"/api/v1.1/logs?"+$.param(e);return new Promise(function(e,t){var a=new XMLHttpRequest;a.open("GET",r),a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.onload=function(){200===this.status?e({status:a.status,text:a.responseText}):t({status:a.status,text:a.responseText})},a.onerror=function(){t({status:a.status,text:a.responseText})},a.send()})}}function StatisticsCtrl(c,t){function p(e){var t={};return e.forEach(function(e){t[e.date]=(t[e.date]||0)+e.total}),t}function a(e){for(var t=[],a=[],r=[],n=moment(),s=function(e){switch(e){case"day":return moment().subtract(30,"day").startOf("day");case"week":return moment().subtract(3,"month").startOf("isoWeek");case"month":return moment().subtract(12,"month").startOf("month")}}(c.unit||"day"),i=p(e.sent||[]),o=p(e.failed||[]);s.isBefore(n);){var l=s.format("YYYY-MM-DD");t.push(i[l]||0),a.push(o[l]||0),r.push(l),s.add(1,c.unit)}c.statisticModel={unit:c.unit,labels:r,datasets:[{data:t,backgroundColor:"rgba(46, 142, 0, 0.2)",hoverBackgroundColor:"rgba(46, 142, 0, 0.5)",borderColor:"rgba(46, 142, 0, 1)",borderWidth:1,label:"Sent emails"},{data:a,backgroundColor:"rgba(255, 68, 0, 0.2)",hoverBackgroundColor:"rgba(255, 68, 0, 0.5)",borderColor:"rgba(255, 68, 0, 1)",borderWidth:1,label:"Errors"}]}}function r(e){console.error("Query statistics error. error:%s",e)}function n(e){return t.get(c.CONFIG.server+"/api/v1.0/statistics",{params:{user_id:Inffuse.user.id(),accessToken:Inffuse.user.accessToken(),unit:e}}).then(function(e){a(e.data)},r)}c.loading=!1,c.init=function(){c.unit="day",n(c.unit)},c.onUnitChange=function(e){n(c.unit=e)}}function ContactsCtrl(n,r){n.current_page=1,n.page_length=50,n.isLastPage=!0,n.count_start=0,n.filter_template="",n.template_filters=[],n.contacts=[],n.loading=!1,n.init=function(){n.reset_filters(),n.refresh()},n.reset_filters=function(){n.template_filters=[];for(var e=0;e<n.data.templates.length;e++)n.template_filters.push({id:n.data.templates[e].id,name:n.data.templates[e].name})},n.refresh=function(){n.loading=!0;var e={user_id:Inffuse.user.id(),accessToken:Inffuse.user.accessToken()};n.filter_template&&(e.template_id=n.filter_template),n.exportURL=n.CONFIG.server+"/api/v1.0/contacts/export?"+$.param(e),e.page=n.current_page,e.count=n.page_length;var t=n.CONFIG.server+"/api/v1.0/contacts/?"+$.param(e);return r.get(t).success(function(e,t,a,r){n.loading=!1,n.contacts=e.rows,n.count_start=(n.current_page-1)*n.page_length,n.isLastPage=e.is_last_page}).error(function(e,t,a,r){n.loading=!1,console.error("listContacts FAILED. error=",err),n.$apply()})},n.deleteContact=function(e){n.loading=!0;var t=$.param({user_id:Inffuse.user.id(),accessToken:Inffuse.user.accessToken()}),a=n.CONFIG.server+"/api/v1.0/contacts/"+e+"?"+t;return r.delete(a).success(function(e,t,a,r){n.refresh(),n.loading=!1}).error(function(e,t,a,r){console.error("Delete contact error. status:%d, error:%s",t,e),n.loading=!1})}}InffuseSDK.server="https://inffuse.emailjs.com",InffuseSDK.context_params={platform:"web"},InffuseSDK.init(function(e){window.Inffuse=e,angular.element(document).ready(function(){angular.bootstrap(document,["App"])})}),HomeCtrl.ready={},angular.module("App").controller("HomeCtrl",["$scope","$http","$location","$window","$routeParams",HomeCtrl]),ServicesCtrl.ready={},angular.module("App").controller("ServicesCtrl",["$scope","$http","$location","$routeParams",ServicesCtrl]),EmailTemplatesCtrl.ready={templatesService:["$q","$route",function(e,t){var a=e.defer();return Inffuse.user.getDataStore().loadData("templates").then(function(e){var t=e.value;a.resolve(t)}).fail(function(e){console.error("ERROR load templates:",e)}),a.promise}]},angular.module("App").controller("EmailTemplatesCtrl",["templatesService","$scope","$http","$location","$q","$routeParams",EmailTemplatesCtrl]),EmailTemplateCtrl.ready={templatesService:["$q","$route",function(e,t){var a=e.defer();return Inffuse.user.getDataStore().loadData("templates").then(function(e){var t=e.value;a.resolve(t)}).fail(function(e){console.error("ERROR load templates:",e)}),a.promise}]},angular.module("App").controller("EmailTemplateCtrl",["templatesService","$scope","$http","$location","$q","$routeParams",EmailTemplateCtrl]),UserCtrl.ready={},angular.module("App").controller("UserCtrl",["$scope","$http","$location","$window","$routeParams","$timeout",UserCtrl]),EmailHistoryCtrl.ready={},angular.module("App").controller("EmailHistoryCtrl",["$scope","$http","$location","$window","$routeParams",EmailHistoryCtrl]),LogsCtrl.ready={},angular.module("App").controller("LogsCtrl",["$scope",LogsCtrl]),angular.module("App").controller("StatisticsCtrl",["$scope","$http",StatisticsCtrl]),ContactsCtrl.ready={},angular.module("App").controller("ContactsCtrl",["$scope","$http",ContactsCtrl]),angular.module("App").component("ejCheckbox",{templateUrl:"/components/ej-checkbox/ej-checkbox.html",bindings:{uid:"@",ngModel:"<",label:"@?",onChange:"&?"},controllerAs:"ejCheckboxCtrl",controller:[function(){var t=this;this.onChecked=function(e){t.onChange&&t.onChange({value:e})}}]}),angular.module("App").component("ejTooltip",{templateUrl:"/components/ej-tooltip/ej-tooltip.html",bindings:{label:"@"},controllerAs:"ejTooltipCtrl",controller:[function(){}]}),angular.module("App").component("ejBarChart",{templateUrl:"/components/ej-bar-chart/ej-bar-chart.html",bindings:{model:"<"},controllerAs:"ejBarChartCtrl",controller:["$window","$element",function(e,t){var a=this,n=null,r=null;function s(e){return e?1e6<e?(e/1e6|0)+"M":1e3<e?(e/1e3|0)+"K":e:""}this.$onInit=function(){r=t.find(".bar-chart-canvas")[0],(n=new e.Chart(r,{type:"bar",options:{legend:{display:!1},scales:{xAxes:[{stacked:!0,type:"time",time:{tooltipFormat:"ddd, DD MMM YYYY",unit:a.unit,minUnit:"day",displayFormats:{day:"DD-MMM 'YY",week:"Wo [week]",month:"MMM 'YY"}},ticks:{source:"labels",autoSkip:!0,maxRotation:0,maxTicksLimit:5}}],yAxes:[{stacked:!0,type:"linear",ticks:{autoSkip:!0,beginAtZero:!0,maxRotation:0,maxTicksLimit:10,min:0,callback:s}}]},tooltips:{mode:"index",titleMarginBottom:10,cornerRadius:3,xPadding:12,yPadding:10,titleFontFamily:"'Roboto', sans-serif",bodyFontFamily:"'Roboto', sans-serif"}}})).render()},this.$onChanges=function(e){if(e.model&&e.model.currentValue){var t=e.model.currentValue;r=t.datasets,n&&(n.data.datasets=r),a=t.labels,n&&(n.data.labels=a),function(e){if(n)switch(n.options.scales.xAxes[0].time.unit=e){case"month":n.options.scales.xAxes[0].time.tooltipFormat="MMMM YYYY";break;case"week":n.options.scales.xAxes[0].time.tooltipFormat="Wo [week of] YYYY";break;default:n.options.scales.xAxes[0].time.tooltipFormat="ddd, DD MMM YYYY"}}(t.unit),n&&n.update({duration:300})}var a,r},this.$onDestroy=function(){r=null,n.destroy()}}]});